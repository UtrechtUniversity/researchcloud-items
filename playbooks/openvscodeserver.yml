---
- name: Install OpenVSCode Server
  hosts: localhost
  gather_facts: true
  vars:
    _openvscode_fqdn: "{{ ('molecule-notest' in ansible_skip_tags) | ternary('localhost', openvscode_fqdn) }}"
    _openvscode_base_path: "{{ openvscode_base_path | default('/', true) }}"
    _openvscode_jupyter_force_install: "{{ openvscode_jupyter_force_install | default(false, true) | bool }}" # should be set to true if a previous component has already installed JupyterHub.
  roles:
    - role: openvscodeserver
    - role: jupyterhub_standalone_proxy
      when: _openvscode_jupyter_force_install
      # install jupyterhub and openvscodeserver as a standalone app.
      vars:
        jupyterhub_uri: "{{ _openvscode_base_path }}"
        jhsp_external_addr: "{{ _openvscode_fqdn }}"
    - role: jupyterhub_app
      vars:
        jupyterhub_app_name: openvscode
        jupyterhub_app_venv: "{{ openvscode_jupyter_venv_path | default('') }}"
        jupyterhub_app_config_dir: "{{ openvscode_jupyter_config_dir | default('') }}"
        jupyterhub_app_pip: jupyter-openvscodeserver-proxy==0.9.3 # this will install the extension even when running in standalone mode, but in that case it will do nothing.
        jupyterhub_app_pip_executable: "{{ _openvscode_jupyter_force_install | ternary('uv_pip', 'pip') }}" # when force install is true, uv will be installed -- use it for better performance.
        jupyterhub_app_standalone_config: |
          from utils import *

          patch_check_origin() # apply monkeypatch for custom CORS allowlist for websockets

          c.StandaloneProxyServer.unix_socket = True

          c.StandaloneProxyServer.command =  [
              "/opt/openvscode-server/bin/openvscode-server",
              "--disable-telemetry",
              "--accept-server-license-terms",
              "--server-base-path={{ _openvscode_base_path }}",
              "--socket-path={unix_socket}",
              "--without-connection-token",
          ]
