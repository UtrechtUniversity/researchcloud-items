---
- name: Install OpenVSCode Server
  hosts: localhost
  gather_facts: true
  vars:
    _openvscode_pip_executable: "{{ openvscode_pip_executable | default('pip', true) }}"
    _openvscode_standalone: "{{ openvscode_standalone | default(true, true) }}"
    _openvscode_base_path: "{{ openvscode_base_path | default('/', true) }}"
    _openvscode_jupyter_venv_path: "{{ openvscode_jupyter_venv_path | default(jupyterhub_venv_path, true) }}"

  roles:
    - role: openvscodeserver
    - role: jupyterhub_standalone_proxy
      when: _openvscode_standalone # install jupyterhub and openvscodeserver as a standalone app.
      vars:
        jupyterhub_uri: "{{ _openvscode_base_path }}"
        jhsp_standalone_proxy_config: |
          c.StandaloneProxyServer.command = [
              "{{ openvscodeserver_cmd_path }}",
              "--disable-telemetry",
              "--accept-server-license-terms",
              "--server-base-path={{ _openvscode_base_path }}"
              "--socket-path={unix_socket}"
          ]
          # - "--server-data-dir="
          # - "--user-data-dir="
          # - "--extensions-dir="

  tasks:
    - name: Install Jupyter Server OpenVSCode extension
      when: not _openvscode_standalone # jupyterhub is already installed, add an extension for openvscodeserver.
      ansible.builtin.pip:
        executable: "{{ _openvscode_pip_executable }}"
        name: jupyter-openvscodeserver-proxy==0.9.3
      environment:
        VIRTUAL_ENV: "{{ _openvscode_jupyter_venv_path }}"
