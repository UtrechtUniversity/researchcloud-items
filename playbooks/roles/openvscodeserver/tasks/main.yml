---
- name: Get latest openvscode-server version # noqa: command-instead-of-module
  when: openvscodeserver_version | length == 0
  changed_when: false
  ansible.builtin.shell: |
    set -o pipefail
    curl {{ openvscode_latest_url }} | jq -r '(.assets[] | select(.name | endswith("dist")).browser_download_url)'
  register: openvscodeserver_get_latest
  args:
    executable: bash

- name: Set dowload URL
  ansible.builtin.set_fact:
    openvscode_server_download_url: "{{ openvscodeserver_get_latest.stdout | default(openvscodeserver_default_download_url) }}"

- name: Download and unarchive openvscode-server
  ansible.builtin.unarchive:
    src: "{{ openvscode_server_download_url }}"
    dest: "{{ openvscode_server_dir }}"
    remote_src: true
    user: "{{ openvscode_server_user }}"
    group: "{{ openvscode_server_group }}"
    mode: "0755"

- name: Set location of openvscode-server cmd for other roles
  ansible.builtin.set_fact:
    openvscode_server_cmd_path: "{{ openvscode_server_dir }}/bin/openvscode-server"
