---
- name: Get latest openvscode-server download URL from GitHub API # noqa: command-instead-of-module
  when: openvscodeserver_version | length == 0
  changed_when: false
  ansible.builtin.shell: |
    set -o pipefail
    curl {{ openvscodeserver_latest_url }} | jq -r '(.assets[] | select(.name | endswith("{{ openvscodeserver_arch }}{{ openvscodeserver_ext }}")).browser_download_url)'
  register: openvscodeserver_get_latest
  args:
    executable: bash

- name: Set dowload URL
  ansible.builtin.set_fact:
    openvscodeserver_download_url: "{{ openvscodeserver_get_latest.stdout | default(openvscodeserver_default_download_url) }}"

- name: Create openvscodeserver basedir
  ansible.builtin.file:
    dest: "{{ openvscodeserver_dir | dirname }}"
    state: directory
    mode: "0755"
    owner: "{{ openvscodeserver_user | default(omit, true) }}"
    group: "{{ openvscodeserver_group | default(omit, true) }}"

- name: Download and unarchive openvscode-server
  ansible.builtin.unarchive:
    src: "{{ openvscodeserver_download_url }}"
    dest: "{{ openvscodeserver_dir }}"
    remote_src: true
    owner: "{{ openvscodeserver_user }}"
    group: "{{ openvscodeserver_group }}"
    mode: "0755"

- name: Set location of openvscode-server cmd for other roles
  ansible.builtin.set_fact:
    openvscodeserver_cmd_path: "{{ openvscodeserver_dir }}/bin/openvscode-server"
