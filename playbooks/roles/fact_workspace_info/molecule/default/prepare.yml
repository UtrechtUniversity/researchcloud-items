---
- name: Prepare
  hosts: all
  gather_facts: false
  tasks:
    - name: Install dependencies for mock API server
      ansible.builtin.pip:
        name: httpserver

    - name: Add api endpoint mock script
      ansible.builtin.copy:
        src: ../files/mock_api.py
        dest: /mock_api.py

    - name: Run mock API server on port 8080
      ansible.builtin.shell: nohup python3 /mock_api.py </dev/null >/dev/null 2>&1 &

    - name: Overwrite test image's user endpoint API URL to our mock server
      ansible.builtin.replace:
        path: /etc/rsc/workspace.json
        regexp: 'github.com' # test image build sets the user API URL to github.com
        replace: 'http://localhost:8080'

    - name: Debug
      ansible.builtin.command: cat /etc/rsc/workspace.json
      register: debugout
