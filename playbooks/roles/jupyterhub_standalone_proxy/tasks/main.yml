---
- name: Install JupyterHub
  ansible.builtin.include_role:
    name: jupyterhub
  vars:
    jupyterhub_user: "{{ jhsp_jupyterhub_user }}"
    jupyterhub_enable_notebooks: "{{ jhsp_enable_notebook }}"
    jupyterhub_extra_pkgs: "{{ jhsp_basic_pkgs + jhsp_extra_pkgs }}"
    jupyterhub_allowed_users_group: "{{ jhsp_jupyterhub_allowed_users_group }}"
    jupyterhub_config_env_keep: "{{ jhsp_config_env_keep | default(omit, true) }}"
    jupyterhub_config_extra: |
      c.JupyterHub.allow_named_servers = {{ jhsp_allow_named_servers | ternary('True', 'False') }}
      {% if (jhsp_standalone_proxy_cmd_args | length == 0) or (jhsp_standalone_proxy_config | length > 0) %}
      # If a proxy config file was configured, the following code will load all standalone proxy configs in {{ jhsp_standalone_proxy_config_dir }}
      import sys
      sys.path.append('{{ jhsp_standalone_proxy_config_dir | dirname }}')
      from standalone.utils import get_standalone_proxy_config
      c.Spawner = get_standalone_proxy_config('{{ jhsp_standalone_proxy_config_dir }}', c.Spawner)
      {% endif %}
      {{ jhsp_config_extra }}

- name: Install sudospawner-singleuser script
  ansible.builtin.template:
    force: "{{ jhsp_force_install }}"
    dest: "{{ jupyterhub_venv_path }}/bin/sudospawner-singleuser"
    src: templates/sudospawner-singleuser.j2
    owner: "{{ jhsp_jupyterhub_user }}"
    group: "{{ jhsp_jupyterhub_allowed_users_group }}"
    mode: "0750" # important: users in the hub user group may not be allowed to edit this file!

- name: Create standalone config dir and files
  block:
    # SECURITY NOTE: It is essential that the config files in the standalone config dir are not user-editable!
    # If an end user OR the user under which JupyterHub is running ('jupyter') could edit this file,
    # then the command run by jupyter-standaloneproxy could be arbitrarily changed.
    # This means that arbitrary commands could be run with sudospawner.
    # We prevent this by setting root as the owner and mode "0640".
    # The file should be readable by users in the hub-users group (default: 'jupyterhub'),
    # because it will be read by jupyter-standalone executed as one of the 'regular' users.
    # This ensures that only the intended command specified by jhsp_standalone_proxy_cmd and jhsp_standalone_proxy_cmd_args
    # can ever by run by sudospawner.

    - name: Create standalone proxy config dir
      ansible.builtin.file:
        dest: "{{ jhsp_standalone_proxy_config_dir }}"
        owner: root
        group: "{{ jhsp_jupyterhub_allowed_users_group }}"
        mode: "0755"
        state: directory

    - name: Create user-provided standalone proxy config
      notify: Reload jupyterhub service
      when: jhsp_standalone_proxy_config | length > 0
      ansible.builtin.copy:
        force: "{{ jhsp_force_install }}"
        dest: "{{ jhsp_standalone_proxy_config_file }}"
        owner: root
        group: "{{ jhsp_jupyterhub_allowed_users_group }}"
        mode: "0644"
        content: "{{ jhsp_standalone_proxy_config }}"

    - name: Create standalone proxy utils
      ansible.builtin.template:
        force: "{{ jhsp_force_install }}"
        dest: "{{ jhsp_standalone_proxy_config_dir }}/utils.py"
        src: templates/utils.py.j2
        owner: root
        group: "{{ jhsp_jupyterhub_allowed_users_group }}"
        mode: "0644"

    - name: Create standalone proxy module init file
      ansible.builtin.copy:
        dest: "{{ jhsp_standalone_proxy_config_dir }}/__init__.py"
        owner: root
        group: "{{ jhsp_jupyterhub_allowed_users_group }}"
        mode: "0644"
        content: ""
