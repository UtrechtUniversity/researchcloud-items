---
#
# Matlab installation requires that the target machine must locally have a file with Matlab software ISO image 
#    NB: You should obtain this ISO image from MathWorks Inc.
#
- name: check if the configuration file exists
  stat:
    path: "{{ matlab_configfile_path }}"
  register: matlab_c 

- name: if config file exists, load its content into Ansible vars. If not, just rely on defaults.
  include_vars:
    file: "{{ matlab_configfile_path }}"
  when: matlab_c.stat.exists

- name: create mountpoint /mnt/matlab-iso
  file:
    dest: "/mnt/matlab-iso"
    state: directory
    mode: 0755
    owner: root
    group: root

- name: mount Matlab software iso image as /mnt/matlab-iso
  tags: molecule-notest  # mounting iso's within containers is too complicated
  mount:
    path: /mnt/matlab-iso
    src: "{{ matlab_iso_dir }}/{{ matlab_iso_file }}"
    fstype: iso9660
    opts: loop
    state: mounted

- name: prepare a silent install inputfile
  template:
    owner: root
    group: root
    mode: 0644
    src: "installer_input.txt.j2"
    dest: "/root/matlab_installer_input.txt"

- name: prepare the license.dat file
  template:
    owner: root
    group: root
    mode: 0644
    src: "license.dat.j2"
    dest: "/root/license.dat"

- name: create Matlab target dir
  file:
    dest: "{{ matlab_dir }}"
    state: directory
    mode: 0755
    owner: root
    group: root

# NB: may take 30 min and 20 GB disk space for full product install
- name: install Matlab products using silent installation. check log in /tmp for progress
  tags: molecule-notest
  command: /mnt/matlab-iso/install -inputFile /root/matlab_installer_input.txt
  args:
    chdir: /mnt/matlab-iso
  register: matlab_i

- name: ensure filesystems are at rest before unmount
  command: "sync"
  changed_when: false

- name: unmount Matlab software iso image, no longer needed
  tags: molecule-notest
  mount:
    path: /mnt/matlab-iso
    state: unmounted

- name: install desktop launcher
  when: fact_desktop_workspace
  import_tasks: desktop.yml

# commandline wrapper will try per-user license before network license
- name: create commandline wrapper to matlab executable
  template:
    owner: root
    group: root
    mode: 0755
    src: "matlab.j2"
    dest: /usr/local/bin/matlab
