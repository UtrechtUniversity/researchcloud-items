---
- name: Install dependencies
  ansible.builtin.package:
    name:
      - default-jre
      - unzip # for unzipping extensions
    state: present

- name: Get latest openrefine download URL from GitHub API # noqa: command-instead-of-module
  when: openrefine_version | length == 0
  changed_when: false
  ansible.builtin.shell: |
    set -o pipefail
    curl {{ openrefine_latest_url }} | jq -r '(.assets[] | select(.name | endswith("{{ openrefine_ext }}")).browser_download_url)'
  register: openrefine_get_latest
  args:
    executable: bash

- name: Set dowload URL
  ansible.builtin.set_fact:
    openrefine_download_url: "{{ openrefine_get_latest.stdout | default(openrefine_default_download_url) }}"

- name: Create openrefine base dir
  ansible.builtin.file:
    dest: "{{ openrefine_dir | dirname }}"
    state: directory
    mode: "0755"
    owner: "{{ openrefine_user | default(omit, true) }}"
    group: "{{ openrefine_group | default(omit, true) }}"

- name: Download and unarchive openrefine
  ansible.builtin.unarchive:
    src: "{{ openrefine_download_url }}"
    dest: "{{ openrefine_dir | dirname }}"
    remote_src: true
    owner: "{{ openrefine_user }}"
    group: "{{ openrefine_group }}"
    mode: "0755"
    creates: "{{ openrefine_dir }}"
  register: openrefine_download

- name: Find exact name of extracted folder
  when: openrefine_download.changed
  ansible.builtin.find:
    paths: "{{ openrefine_dir | dirname }}"
    patterns: 'openrefine-*'
    file_type: directory
  register: openrefine_find_unpacked

- name: Create link to extracted folder
  when: openrefine_download.changed
  ansible.builtin.file:
    src: "{{ openrefine_find_unpacked.files[0].path }}"
    dest: "{{ openrefine_dir }}"
    owner: "{{ openrefine_user }}"
    group: "{{ openrefine_group }}"
    mode: "0755"
    state: link

- name: Set location of openrefine cmd for other roles
  ansible.builtin.set_fact:
    openrefine_cmd_path: "{{ openrefine_dir }}/refine"

- name: Place icon
  ansible.builtin.copy:
    src: files/openrefine_logo.svg
    dest: "{{ openrefine_icon }}"
    owner: "{{ openrefine_user }}"
    group: "{{ openrefine_group }}"
    mode: "0644"

- name: Set icon path fact
  ansible.builtin.set_fact:
    openrefine_icon_path: "{{ openrefine_icon }}"

- name: Install openrefine extensions
  ansible.builtin.include_tasks: extensions.yml
  loop: "{{ openrefine_extensions }}"
