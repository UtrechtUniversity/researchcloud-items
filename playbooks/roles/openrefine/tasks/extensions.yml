---
- name: Get latest extension download URL from GitHub API # noqa: command-instead-of-module
  when: item.get_latest is defined and item.get_latest
  changed_when: false
  ansible.builtin.shell: |
    set -o pipefail
    curl {{ item.url }} | jq -r '(.assets[] | select(.name | endswith("{{ item.ext | default('.zip') }}")).browser_download_url)'
  register: _openrefine_ext_get_latest
  failed_when: _openrefine_ext_get_latest.failed or (_openrefine_ext_get_latest.stdout | length) == 0
  args:
    executable: bash

- name: Set extension dowload URL
  ansible.builtin.set_fact:
    _openrefine_ext_download_url: "{{ _openrefine_ext_get_latest.stdout | default(item.url) }}"

- name: Download and unarchive openrefine extension
  ansible.builtin.unarchive:
    src: "{{ _openrefine_ext_download_url }}"
    dest: "{{ openrefine_dir }}/webapp/extensions/"
    remote_src: true
    owner: "{{ openrefine_user }}"
    group: "{{ openrefine_group }}"
    mode: "0755"
    creates: "{{ openrefine_dir }}/webapp/extensions/{{ item.name }}"
  register: openrefine_download
