---
- name: Install package sshfs
  package:
    name: sshfs
    state: present

- name: Ensure that local mountpoint exists
  file:
    path: "{{ sshfs_connection_info.mountpoint }}"
    state: directory
    owner: "{{ sshfs_connection_info.username }}"

- name: Enable user_allow_other in fuse config
  tags: molecule-idempotence-notest
  lineinfile:
    path: /etc/fuse.conf
    regexp: '^(#)?user_allow_other$'
    line: 'user_allow_other'
    state: present

# below is a hack to split the task of mounting the remote filesystem
# in two parts so that privileged part of update /etc/fstab is done by root:
# - first, root ensures the line is added to fstab
# - then, mount is run as the robotuser to use its credentials
- name: Add remote filesystem to /etc/fstab and mount it
  become_user: "{{ sshfs_connection_info.username }}"
  become: "{{ item.become }}"
  when: "'molecule-notest' not in ansible_skip_tags or item.state == 'present'"  # don't actually mount when running in container
  mount:
    src: "sshfs#{{ sshfs_connection_info.username }}@{{ sshfs_connection_info.server }}:{{ sshfs_connection_info.sourcepath }}"
    path: "{{ sshfs_connection_info.mountpoint }}"
    fstype: "fuse"
    opts: "_netdev,port={{ sshfs_connection_info.port }},user,idmap=user,allow_other,default_permissions,reconnect,ServerAliveInterval=20,ServerAliveCountMax=5"
    state: "{{ item.state }}"
  loop:
    - become: false
      state: present
    - become: true
      state: mounted
