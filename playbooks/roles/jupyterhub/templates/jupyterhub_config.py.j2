# This file is managed by Ansible

from traitlets import Unicode

{% if jupyterhub_auth == 'sram' or jupyterhub_activate_remote_user_auth %}

from jupyterhub.handlers import LogoutHandler
from jhub_remote_user_authenticator.remote_user_auth import RemoteUserLoginHandler, RemoteUserAuthenticator


class MyLogoutHandler(LogoutHandler):

  async def render_logout_page(self):
    logout_endpoint = self.authenticator.logout_endpoint

    self.redirect(logout_endpoint)

class MyAuthenticator(RemoteUserAuthenticator):
  """
  Accept the authenticated user from the header, based on an Remote_User
  """

  logout_endpoint = Unicode(
    default_value='/logout',
    config=True,
    help="""URL to log the user out and clean the session""")

  def get_handlers(self, app):
    return [
      (r'/login', RemoteUserLoginHandler),
      (r'/logout', MyLogoutHandler),
    ]

c.JupyterHub.authenticator_class = MyAuthenticator
c.JupyterHub.shutdown_on_logout = True

c.AccessTokenAuthenticator.header_name = "{{ jupyterhub_remote_user_header }}"
c.AccessTokenAuthenticator.logout_endpoint = "/logout"
{% endif %}

# Spawner config

c.JupyterHub.spawner_class = 'sudospawner.SudoSpawner'
c.SudoSpawner.sudospawner_path = '{{ jupyterhub_sudospawner_path }}'

origin = "*" # can also be the specific URL of the JupyterHub proxy server (e.g. http://localhost:8080)
c.Spawner.args = [
  '--NotebookApp.allow_origin={0}'.format(origin), # allow CORS from 'origin'
  '--transport=ipc' # use unix sockets to communicate with kernels
]
c.Spawner.env_keep = {{ jupyterhub_config_env_keep | string }}

# Server config
{% if jupyterhub_enable_unix_socket %}
c.JupyterHub.hub_bind_url = "unix+http://{{ jupyterhub_user_home | replace("/", "%2F) }}%2Fjupyterhub.sock"
{% else %}
c.JupyterHub.ip = "{{ jupyterhub_bind_addr }}"
c.JypyterHub.port = {{ jupyterhub_port | int }}
{% endif %}
c.JupyterHub.base_url = "{{ jupyterhub_uri }}"

# Configure paths for essential server files
c.JupyterHub.cookie_secret_file = "{{ jupyterhub_user_home }}/jupyterhub_cookie_secret"
c.JupyterHub.db_url = "sqlite:///{{ jupyterhub_user_home }}/jupyterhub.sqlite"
c.ConfigurableHTTPProxy.pid_file = "{{ jupyterhub_user_home }}/jupyter-proxy.pid"

# Notebook config

{% if jupyterhub_enable_notebooks %}
# This is only required when JupyterHub is actually being used to serve notebooks.
# This is the default case. But it will not be the case, for instance, if JupyterHub is being used solely to serve apps using the standalone proxy.
c.Spawner.default_url = '/lab?reset'
c.Spawner.notebook_dir = '~'
{% endif %}

# BEGIN: extra configuration provided to the jupyterhub role below
{{ jupyterhub_config_extra }}
# END
