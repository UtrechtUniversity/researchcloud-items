# Generated by Ansible

location {{ item.location | default('') }} {
    ### Timeouts and limits
    proxy_read_timeout {{ item.proxy_read_timeout | default('300') }};
    proxy_connect_timeout {{ item.proxy_connect_timeout | default('300') }};
    proxy_send_timeout {{ item.proxy_send_timeout | default('300') }};
    send_timeout {{ item.send_timeout | default('300') }};

    client_max_body_size {{ item.client_max_body_size | default('10G') }};

    {% if item.auth is defined  %}
    {% if item.auth.type == 'sram' %}
    ### Authentication
    error_page 401 = @custom_401;
    auth_request /validate;
    auth_request_set $username $upstream_http_username;
    proxy_set_header REMOTE_USER $username;
    {% elif item.auth.type  == 'basic' %}
    auth_basic "{{ auth.message | default('Secure') }}";
    auth_basic_user_file {{ htpasswd_location }}/{{ item.auth.auth_info }};
    {% elif item.auth.type == 'noauth' %}
    auth_basic "off";
    auth_request "off";
    {% endif %}
    {% endif %}

    ### Proxy settings
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For {{item.x_forwarded_for | default('$proxy_add_x_forwarded_for')}};

    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection $connection_upgrade;

    proxy_redirect {{ item.proxy_redirect | default('off') }};
    proxy_set_header Host $host;
    proxy_pass {{ item.backend }};
}