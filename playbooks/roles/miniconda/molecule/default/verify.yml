---
- name: Verify
  hosts: all
  gather_facts: false
  tasks:
    - name: Ensure conda is not auto-initialized
      ansible.builtin.lineinfile:
        name: /home/testuser/.bashrc
        line: conda initialize >>>
        state: present
      check_mode: true
      register: conda_auto_inited
      failed_when: (conda_auto_inited is not changed) or (conda_auto_inited is failed)

    - name: Stat miniconda global
      ansible.builtin.stat:
        path: /data/ext/miniconda/condabin/conda
      register: miniconda_systemwide

    - name: Test conda create with root
      ansible.builtin.command: bash -l -c 'conda create -p /data/ext/miniconda/envs/testenv -y --override-channels -c conda-forge conda-forge::python conda-forge::ipykernel'
      register: conda_create

    - name: Assert packages installed globally
      ansible.builtin.find:
        paths: /data/ext/miniconda/pkgs/
        patterns: "*ipykernel*"
        file_type: directory
      register: find_pkgs

    # Ensure the conda env created by root is available for testuser
    - name: Conda env list
      become: true
      become_user: testuser
      ansible.builtin.command: bash -l -c 'conda env list'
      register: conda_env_list

    - name: Assertions
      ansible.builtin.assert:
        that:
          - miniconda_systemwide.stat.exists is true
          - '"environment location: /data/ext/miniconda/envs/testenv" in conda_create.stdout'
          - '"/data/ext/miniconda/envs/test" in conda_env_list.stdout'
          - '(find_pkgs.files | length ) > 0'
