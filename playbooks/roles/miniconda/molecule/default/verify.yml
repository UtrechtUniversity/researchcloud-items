---
- name: Verify
  hosts: all
  gather_facts: false
  tasks:
    - name: Ensure conda is not auto-initialized
      ansible.builtin.lineinfile:
        name: /home/testuser/.bashrc
        line: conda initialize >>>
        state: present
      check_mode: true
      register: conda_auto_inited
      failed_when: (conda_auto_inited is not changed) or (conda_auto_inited is failed)

    - name: Stat miniconda global
      ansible.builtin.stat:
        path: /data/ext/miniconda/condabin/conda
      register: miniconda_systemwide

    - name: Create dummy conda file
      ansible.builtin.copy:
        dest: /root/environment.yml
        owner: root
        group: root
        mode: "0750"
        content: |
          name: test
          dependencies:
            - ipykernel

    - name: Test conda create with root
      ansible.builtin.command: bash -l -c 'conda create -n test -y --override-channels -c conda-forge'
      register: conda_create

    # Ensure the conda env created by root is available for testuser
    - name: Conda env list
      become: true
      become_user: testuser
      ansible.builtin.command: bash -l -c 'conda env list'
      register: conda_env_list

    - name: Assertions
      ansible.builtin.assert:
        that:
          - miniconda_systemwide.stat.exists is true
          - '"environment location: /data/ext/miniconda" in conda_create.stdout'
          - '"/data/ext/miniconda/envs/test" in conda_env_list.stdout'
