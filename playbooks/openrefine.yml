---
- name: Install OpenRefine
  hosts: localhost
  gather_facts: true
  vars:
    _openrefine_fqdn: "{{ ('molecule-notest' in ansible_skip_tags) | ternary('localhost', openrefine_fqdn) }}"
    _openrefine_base_path: "{{ openrefine_base_path | default('/', true) }}"
    _openrefine_jupyter_force_install: "{{ openrefine_jupyter_force_install | default(false, true) | bool }}" # should be set to true unless a previous component has already installed JupyterHub.
    _openrefine_default_extensions:
      - name: file-extensions # name of archive after extraction
        get_latest: true
        url: https://api.github.com/repos/OpenRefine/FilesExtension/releases/latest
        ext: .zip
    _openrefine_extra_extensions: |
      {% if openrefine_extra_extensions is defined and openrefine_extra_extensions | length > 0 %}
      {{ openrefine_extra_extensions.split('\\n') | join('\n') | from_yaml }}
      {% else %}
      {{ [] }}
      {% endif %}
  roles:
    - role: openrefine
      vars:
        openrefine_extensions: "{{ (_openrefine_default_extensions + _openrefine_extra_extensions) | select }}"
    - role: jupyterhub_standalone_proxy
      when: _openrefine_jupyter_force_install
      # install jupyterhub and openrefine as a standalone app.
      vars:
        jupyterhub_uri: "{{ _openrefine_base_path }}"
        jhsp_external_addr: "{{ _openrefine_fqdn }}"
    - role: jupyterhub_app
      vars:
        jupyterhub_app_name: openrefine
        jupyterhub_app_venv: "{{ openrefine_jupyter_venv_path | default('') }}"
        jupyterhub_app_config_dir: "{{ openrefine_jupyter_config_dir | default('') }}"
        jupyterhub_app_pip_executable: "{{ _openrefine_jupyter_force_install | ternary('uv_pip', 'pip') }}" # when force install is true, uv will be installed -- use it for better performance.
        jupyterhub_app_icon_path: "{{ openrefine_icon_path }}"
        jupyterhub_app_command:
          - "{{ openrefine_cmd_path }}" # set by the `openrefine` role
          - -H
          - "*"
          - -p
          - "{port}" # magic variable that will be substituted with the spawn port by JupyterHub
          - -m # max memory
          - "{{ openrefine_max_memory | default(((ansible_memtotal_mb * 0.85) | int | string) ~ 'M', true) }}"
