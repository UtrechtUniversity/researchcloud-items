---
- name: Verify
  hosts: all
  gather_facts: false
  tasks:
    - name: Turn off apt timers (active by default on the image)
      ansible.builtin.command: "{{ item }}"
      with_items:
        - systemctl stop apt-daily.timer apt-daily-upgrade.timer
        - systemctl disable apt-daily.timer apt-daily-upgrade.timer

    - name: List bootstrap timer
      ansible.builtin.command: "systemctl list-timers upgrade-bootstrap"
      register: bootstrap_timer
      changed_when: false

    - name: Assert bootstrap timer is on
      ansible.builtin.assert:
        that:
          - '"upgrade-bootstrap.service" in bootstrap_timer.stdout'

    - name: Run the bootstrap service
      ansible.builtin.command: "systemctl start upgrade-bootstrap"

    - name: List apt timers
      ansible.builtin.command: "systemctl list-timers *apt*"
      register: apt_timers
      changed_when: false

    - name: Assert apt timers are on
      ansible.builtin.assert:
        that:
          - '"2 timers listed" in apt_timers.stdout'

    - name: List bootstrap timer
      ansible.builtin.command: "systemctl list-timers upgrade-bootstrap"
      register: bootstrap_timer
      changed_when: false

    - name: Assert bootstrap timer is off
      ansible.builtin.assert:
        that:
          - '"0 timers listed" in bootstrap_timer.stdout'
