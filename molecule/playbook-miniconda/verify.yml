---
- name: Verify
  hosts: all
  gather_facts: false
  tasks:

    - name: Runonce for testuser
      become_user: testuser
      become: true
      ansible.builtin.command:
        cmd: bash -l /etc/runonce.d/runonce_conda.sh

    - name: Look for proof that conda init was run
      ansible.builtin.command: grep conda /home/testuser/.bashrc
      register: conda_init

    - name: Create dummy conda file
      ansible.builtin.copy:
        dest: /home/testuser/environment.yml
        owner: testuser
        group: testuser
        mode: "0750"
        content: |
          name: test
          dependencies:
            - ipykernel

    - name: Test conda_create
      become: true
      become_user: testuser
      ansible.builtin.command: bash -l -c 'conda create -n testenv -y --override-channels -c conda-forge'
      register: conda_create

    - name: Assertions
      ansible.builtin.assert:
        that:
          - '"conda initialize >>>" in conda_init.stdout'
          - '"environment location: /home/testuser" in conda_create.stdout'
