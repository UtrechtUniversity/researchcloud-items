---
- name: Converge
  hosts: all
  gather_facts: true
  tasks:
    - name: Test the playbook by executing it using ansible on the workspace
      ansible.builtin.command: ansible-playbook --connection=local -b {{ remote_plugin.arguments }} --extra-vars='{{ remote_plugin.parameters }}' /rsc/plugins/{{ remote_plugin.script_folder | basename }}/{{ remote_plugin.path }}
      register: ansible_on_workspace
      changed_when: "'changed=0' not in ansible_on_workspace.stdout_lines[-1]"
      vars:
        remote_plugin:
          script_type: 'Ansible PlayBook'
          script_folder: "{{ lookup('env', 'PROJECT_DIR') }}/{{ lookup('env', 'PLAYBOOK_DIR') }}"
          path: "{{ lookup('env', 'PLAYBOOK_PATH') }}"
          arguments: '-i 127.0.0.1, --skip-tags notest,molecule-notest'
          parameters: "{{ lookup('env', 'REMOTE_PLUGIN_PARAMS') }}"
