# Following the instructions on https://docs.anaconda.com/anaconda/install/linux/ and https://docs.anaconda.com/anaconda/install/multi-user/, gathered in June 2022.

---
# - name: Install dependencies ## ANY dependencies to install???
#  include: "dependencies_{{ ansible_pkg_mgr }}.yml"
#
# The get_url ansible module in the task below does not create a directory
- name: Ensure download dir exists
  file:
    path: "{{ agisoft_download_dest }}"
    state: directory

- name: Download agisoft installation files
  get_url:
    url: "{{ agisoft_url }}"
    dest: "{{ agisoft_download_dest }}"
    mode: 0774

- name: ansible create installation directory 
  file:
    path: "{{ agisoft_install_dir }}"
    state: directory

- name: Extract agisoft to opt for multiple user
  unarchive:
    src: "{{ agisoft_download_dest }}/{{ agisoft_file }}"
    dest: "{{ agisoft_install_dir }}"
    mode: 0755

- name: Create agisoft multi-user group
  group:
      name: agisoft_users
      state: present

# Dev note: in case of multi-user issues: the following two tasks are your best bet to start troubleshooting.
# `s` permission added due to bug: https://github.com/conda/conda/issues/7227
- name: Change agisoft installation dir ownership to multiple user group
  file:
    path: "{{ agisoft_install_dir }}"
    group: agisoft_users
    mode: u+rwxs,g+rwxs,o-rwxs
    recurse: true

# The above task creates a new error, because the application binary cannot be run with setuid permissions.
# TODO The above task and this task should be reworked to only grant the setuid permisison on the directories that require it.

- name: Add users to agisoft multiple user group
  user:
    name: "{{ item.user }}"
    groups: agisoft_users
    append: yes
  with_items:
    - "{{ fact_regular_users }}"

- name: Create license file
  copy:
    dest:  "{{ agisoft_install_dir }}/license.lic"
    content: "{{ content }}"

- name: Install desktop file menu item through role
  include_role:
    name: desktop_file
  vars:
    desktopfile_app_name: agisoft
    desktopfile_sizes:
      - 48
...
