---
- name: Install virtualenv dependency
  apt:
    name: "python3-venv"

- name: Get list of all interative users
  command: "awk -F: '$3 >= 1001 && $1 != \"nobody\" {print $1}' /etc/passwd"
  register: users_list

- name: Ensure Poetry dir exists
  file:
    path: /scratch/poetry
    state: directory
    mode: 0777

- name: Download poetry installer
  get_url:
    url: https://install.python-poetry.org
    dest: /scratch/poetry/install-poetry.py
    mode: 0777
    timeout: 20

- name: Install poetry
  command: python3 /scratch/poetry/install-poetry.py
  become: yes
  become_user: "{{ item }}"
  environment:
    POETRY_HOME: "/home/{{ item }}/.poetry"
  with_items:
    - "{{ users_list.stdout_lines }}"

- name: Set poetry path
  lineinfile:
    path: "/etc/profile"
    line: PATH=$PATH:~/.poetry/bin

#TODO: Add script to install poetry for newly created users after the fact in /usr/local/sbin/adduser.local
...