---
- name: Install virtualenv dependency
  apt:
    name: "python3-venv"

- name: Get list of all interative users
  command: "awk -F: '$3 >= 1001 && $1 != \"nobody\" {print $1}' /etc/passwd"
  register: users_list

- name: Download poetry installer
  get_url:
    url: https://install.python-poetry.org
    dest: "/scratch/poetry/install-poetry.py"
    mode: "0444"
    timeout: 20

- name: Install poetry
  command: "python3 /scratch/install-poetry.py"
  become: yes
  become_user: "{{ item }}"
  environment:
    POETRY_HOME: "/home/{{ item }}/.poetry"
    POETRY_ROOT: "/home/{{ item }}/.poetry"
  with_items:
    - "{{ users_list.stdout_lines }}"

#TODO: Add script to install poetry for newly created users after the fact in /usr/local/sbin/adduser.local
...