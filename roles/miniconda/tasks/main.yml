---
- name: Check if not both systemwide and userspace are true
  when: miniconda_userspace == miniconda_systemwide
  meta: end_play

# The get_url ansible module in the task below does not create a directory
- name: Ensure download dir exists    
  file:
    path: "{{ miniconda_download_dest }}"
    state: directory

- name: Download miniconda installation files
  get_url:
    url: "{{ miniconda_url }}"
    dest: "{{ miniconda_download_dest }}/miniconda.sh"
    mode: 0774

- name: Install per user
  when: miniconda_userspace
  block:
    - name: Install conda for each user individually
      shell: "{{ miniconda_download_dest }}/miniconda.sh -b -p {{ item.home }}/miniconda"
      become: false
      become_user: "{{ item.user }}"
      with_items:
        - "{{ fact_regular_users }}"

- name: Install system-wide
  when: miniconda_systemwide
  block:
    - name: Install conda in shared environments
      shell: "{{ miniconda_download_dest }}/miniconda.sh -b -p {{ miniconda_install_dir }}"

    - name: Create .condarc file for shares packages and environments
      template:
        src: .condarc.j2
        dest: "{{ miniconda_install_dir }}/.condarc"
        mode: 0755

- name: Run `conda init` for every user
  template:
    src: run_conda_init.sh.j2
    dest: "/etc/runonce.d"
    mode: 0755
...
