---
- name: Install PostgreSQL
  include_role:
    name: postgresql
  vars:
    postgresql_provision: false

- name: Create list of databases.
  set_fact:
    databases: "['Camunda', '{{ camunda_database_name }}']"

- name: Create databases.
  postgresql_db:
    state: present
    name: "{{ item }}"
  with_items: "{{ databases }}"
  become: true
  become_user: postgres

- name: Create Camunda schemas.
  command: "psql -U 'postgres' -d 'Camunda' -f '{{ item }}'"
  with_items:
    - /var/lib/camunda/sql/create/postgres_engine_7.17.0-alpha2.sql
    - /var/lib/camunda/sql/create/postgres_identity_7.17.0-alpha2.sql
  become_user: postgres
  become: true
  register: sql_response_variable


# - name: Grant "postgres" user permissions on databases.
#   with_items: "{{ databases }}"

- name: Change postgres user password
  command: "psql -U 'postgres' -d 'Camunda' -f '{{ lookup('template', 'setup.sql') }}'"
  become_user: postgres
  become: true

- name: Download jdbc driver
  get_url: 
    dest: /var/lib/camunda/server/apache-tomcat-9.0.52/lib/postgresql-42.4.0.jar
    url: https://jdbc.postgresql.org/download/postgresql-42.4.0.jar

- name: Edit `server.xml` file to use PostgreSQL
  lineinfile:
    path: /var/lib/camunda/server/apache-tomcat-9.0.52/conf/server.xml
    regexp: "{{ item.original }}"
    line: "{{ item.replacement }}"
    state: present
  with_items:
    - {"original": 'driverClassName="org.h2.Driver"', "replacement": 'driverClassName="org.postgresql.Driver"'}
    - {"original": 'url="jdbc:h2:./camunda-h2-dbs/process-engine;MVCC=TRUE;TRACE_LEVEL_FILE=0;DB_CLOSE_ON_EXIT=FALSE"', "replacement": 'url="jdbc:postgresql://localhost:5432/camunda"'}
    - {"original": 'password="sa"', "replacement": "{{ camunda_postgresql_password }}"}
# - name: Create module.xml


# - name: Edit standalone.xml of Camunda BPM.

...
