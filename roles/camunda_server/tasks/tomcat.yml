---
- name: copy camunda bpm engine config to tomcat config
  copy:
    src: "{{ camunda_tomcatdir }}/conf/bpm-platform.xml"
    remote_src: yes
    dest: "{{ catalina_home }}/conf/bpm-platform.xml"

- name: copy camunda jars to tomcat lib
  copy:
    src: "{{ camunda_dir }}/lib/"
    remote_src: yes
    dest: "{{ catalina_home }}/lib/"

# a copy with remore_src preserves file attribs regardless of mode
# hence we need to set these props using a separate command
- name: set file access rights for files in tomcat lib dir
  command: "chmod -R 0755 {{catalina_home }}/lib"

- name: set file access tights for tomcat ./conf/bpm-platform.xml
  command: "chmod 0755 {{ catalina_home }}/conf/bpm-platform.xml"

- name: add camunda listener to Tomcat server.xml
  lineinfile:
    path: "{{ catalina_home }}/conf/server.xml"
    insertafter: '<Listener className="org.apache.catalina.core.JreMemoryLeakPreventionListener" />'
    line: '<Listener className="org.camunda.bpm.container.impl.tomcat.TomcatBpmPlatformBootstrap" />'

- name: add camunda resources to Tomcat server.xml
  lineinfile:
    path: "{{ catalina_home }}/conf/server.xml"
    insertafter: '<GlobalNamingResources>'
    line: '<Resource name="jdbc/ProcessEngine" auth="Container" type="javax.sql.DataSource" factory="org.apache.tomcat.jdbc.pool.DataSourceFactory" uniqueResourceName="process-engine" driverClassName="org.h2.Driver" url="jdbc:h2:/tmp/camunda-h2-dbs/process-engine;MVCC=TRUE;TRACE_LEVEL_FILE=0;DB_CLOSE_ON_EXIT=FALSE" defaultTransactionIsolation="READ_COMMITTED" username="sa" password="sa" maxTotal="20" minIdle="5" maxIdle="20" /> <Resource name="global/camunda-bpm-platform/process-engine/ProcessEngineService!org.camunda.bpm.ProcessEngineService" auth="Container" type="org.camunda.bpm.ProcessEngineService" description="Camunda Platform Process Engine Service" factory="org.camunda.bpm.container.impl.jndi.ProcessEngineServiceObjectFactory" /> <Resource name="global/camunda-bpm-platform/process-engine/ProcessApplicationService!org.camunda.bpm.ProcessApplicationService" auth="Container" type="org.camunda.bpm.ProcessApplicationService" description="Camunda Platform Process Application Service" factory="org.camunda.bpm.container.impl.jndi.ProcessApplicationServiceObjectFactory" />'
              
- name: copy camunda webapps to tomcat webapps dir
  copy:
    src: "{{ camunda_tomcatdir }}/webapps/{{ item }}/"
    remote_src: yes
    dest: "{{ catalina_home }}/webapps/{{ item }}"
    owner: tomcat
    group: tomcat
    mode: 0755
  with_items:
    - "engine-rest"
    - "camunda"
    - "camunda-welcome"
    - "h2"
    - "camunda-invoice"
  notify: Restart tomcat9
...
